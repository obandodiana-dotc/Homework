<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Real Inventory Policy Simulator</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/heroicons@2.1.3/24/outline/index.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'blue-inventory': '#1D4ED8', // blue-700
                        'green-jit': '#059669', // emerald-600
                        'indigo-sim': '#4F46E5', // indigo-600
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-slate-50 min-h-screen font-sans">
    <header class="bg-white shadow-md mb-8">
        <div class="max-w-7xl mx-auto px-6 py-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
            <div class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8 text-blue-inventory">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.042a4.99 4.99 0 01-4.116 4.608 1.517 1.517 0 01-1.419 0 4.99 4.99 0 01-4.116-4.608L3.75 7.5M10.5 4.875 9 1.5M16.5 4.875 18 1.5"/>
                </svg>
                <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-900">
                    Inventory Policy Simulator
                </h1>
            </div>
            <p class="text-xs text-gray-500 mt-1 sm:mt-0">
                Multi-SKU · EOQ / JIT / Min-Max · Frontend v2.1
            </p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 pb-12 grid grid-cols-1 lg:grid-cols-3 gap-8">

        <section class="bg-white shadow-xl rounded-2xl p-6 space-y-6 lg:col-span-1 border border-slate-100/80">
            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-blue-inventory">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 107.5 7.5H10.5V6z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0013.5 3v7.5z"/>
                </svg>
                Simulation Setup
            </h2>
            

            <div class="space-y-3">
                <div>
                    <label class="text-sm font-medium text-gray-700 block mb-1">Scenario Name</label>
                    <input id="scenarioName"
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-blue-inventory focus:ring-blue-inventory transition"
                           placeholder="e.g. Baseline EOQ vs JIT"/>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-medium text-gray-700 block mb-1">Simulation horizon (days)</label>
                        <input id="simDays" type="number" min="10" max="365" value="120"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-blue-inventory focus:ring-blue-inventory transition"/>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700 block mb-1">Target service level (%)</label>
                        <input id="serviceLevel" type="number" min="80" max="99.9" value="95"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-blue-inventory focus:ring-blue-inventory transition"/>
                    </div>
                </div>
            </div>

            <h3 class="text-base font-bold text-gray-800 pt-4 border-t border-slate-100 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-indigo-500">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.731 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/>
                </svg>
                Manual SKUs Input (2 items)
            </h3>
            
            <div class="border border-blue-100 rounded-lg p-3 bg-blue-50/50 space-y-3">
                <h4 class="font-semibold text-blue-inventory text-sm flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                        <path d="M7 3C5.6 3 4.5 4.1 4.5 5.5v2.75c0 .324.08.643.23.939l1.455 2.871C6.442 12.378 7.155 12.75 8 12.75h4c.845 0 1.558-.372 2.065-.889l1.455-2.871a2.125 2.125 0 00.23-.939V5.5C15.5 4.1 14.4 3 13 3H7zm-3.5 13.5a.5.5 0 01.5-.5h13a.5.5 0 010 1h-13a.5.5 0 01-.5-.5z"/>
                    </svg>
                    SKU 1: Base Product
                </h4>
                <input id="sku1_name" class="w-full border border-gray-300 rounded-lg px-3 py-1.5 text-sm"
                       value="Sneaker A" placeholder="Name (e.g. Sneaker A)"/>

                <div class="grid grid-cols-2 gap-3 text-xs">
                    <div><label class="block text-gray-600">Annual demand D</label><input id="sku1_D" type="number" value="10000" class="w-full border border-gray-300 rounded px-2 py-1 text-xs"/></div>
                    <div><label class="block text-gray-600">Order cost S</label><input id="sku1_S" type="number" value="50" class="w-full border border-gray-300 rounded px-2 py-1 text-xs"/></div>
                    <div><label class="block text-gray-600">Holding cost H (p.u./year)</label><input id="sku1_H" type="number" value="5" class="w-full border border-gray-300 rounded px-2 py-1 text-xs"/></div>
                    <div><label class="block text-gray-600">Lead time (days)</label><input id="sku1_LT" type="number" value="7" class="w-full border border-gray-300 rounded px-2 py-1 text-xs"/></div>
                </div>

                <div>
                    <label class="text-xs block text-gray-600 mb-1">Policy</label>
                    <select id="sku1_policy" class="w-full border border-gray-300 rounded-lg px-2 py-1 text-sm focus:ring-blue-inventory focus:border-blue-inventory">
                        <option value="EOQ">EOQ (Economic Order Quantity)</option>
                        <option value="JIT">JIT (Just-In-Time/Small Lots)</option>
                        <option value="MINMAX">Min-Max (s,S)</option>
                    </select>
                </div>
            </div>

            <div class="border border-emerald-100 rounded-lg p-3 bg-emerald-50/50 space-y-3">
                <h4 class="font-semibold text-green-jit text-sm flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                        <path d="M7 3C5.6 3 4.5 4.1 4.5 5.5v2.75c0 .324.08.643.23.939l1.455 2.871C6.442 12.378 7.155 12.75 8 12.75h4c.845 0 1.558-.372 2.065-.889l1.455-2.871a2.125 2.125 0 00.23-.939V5.5C15.5 4.1 14.4 3 13 3H7zm-3.5 13.5a.5.5 0 01.5-.5h13a.5.5 0 010 1h-13a.5.5 0 01-.5-.5z"/>
                    </svg>
                    SKU 2: Challenger Product
                </h4>
                <input id="sku2_name" class="w-full border border-gray-300 rounded-lg px-3 py-1.5 text-sm"
                       value="Sneaker B" placeholder="Name (e.g. Sneaker B)"/>

                <div class="grid grid-cols-2 gap-3 text-xs">
                    <div><label class="block text-gray-600">Annual demand D</label><input id="sku2_D" type="number" value="6000" class="w-full border border-gray-300 rounded px-2 py-1 text-xs"/></div>
                    <div><label class="block text-gray-600">Order cost S</label><input id="sku2_S" type="number" value="40" class="w-full border border-gray-300 rounded px-2 py-1 text-xs"/></div>
                    <div><label class="block text-gray-600">Holding cost H (p.u./year)</label><input id="sku2_H" type="number" value="3" class="w-full border border-gray-300 rounded px-2 py-1 text-xs"/></div>
                    <div><label class="block text-gray-600">Lead time (days)</label><input id="sku2_LT" type="number" value="5" class="w-full border border-gray-300 rounded px-2 py-1 text-xs"/></div>
                </div>

                <div>
                    <label class="text-xs block text-gray-600 mb-1">Policy</label>
                    <select id="sku2_policy" class="w-full border border-gray-300 rounded-lg px-2 py-1 text-sm focus:ring-green-jit focus:border-green-jit">
                        <option value="EOQ">EOQ (Economic Order Quantity)</option>
                        <option value="JIT">JIT (Just-In-Time/Small Lots)</option>
                        <option value="MINMAX">Min-Max (s,S)</option>
                    </select>
                </div>
            </div>

            <p id="errorBox"
               class="hidden text-xs text-red-700 bg-red-100 border border-red-300 rounded-lg px-3 py-2 mt-4 font-medium">
            </p>

            <div class="pt-2 border-t border-slate-100 space-y-2">
                <button id="runBtn"
                        class="w-full bg-blue-inventory hover:bg-blue-800 text-white text-sm font-semibold px-4 py-2 rounded-lg transition shadow-md hover:shadow-lg">
                    <span class="inline-flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                            <path fill-rule="evenodd" d="M2.5 5.5A.75.75 0 013.25 4h13.5a.75.75 0 01.75.75v10.5a.75.75 0 01-.75.75H3.25a.75.75 0 01-.75-.75v-10.5zM17 5.5v9h-13v-9h13z"/>
                        </svg>
                        ▶ Run & Save Scenario (Manual SKUs)
                    </span>
                </button>

                <button id="runRealBtn"
                        class="w-full bg-green-jit hover:bg-emerald-700 text-white text-sm font-semibold px-4 py-2 rounded-lg transition shadow-md hover:shadow-lg">
                    <span class="inline-flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                            <path fill-rule="evenodd" d="M6 3.5a.5.5 0 01.5-.5h7a.5.5 0 01.5.5v3.5h-8V3.5zM7.5 7h5V4.5h-5V7zM3 10a2 2 0 012-2h10a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5zm2 0h10v5H5v-5z" clip-rule="evenodd"/>
                        </svg>
                        ▶ Run Simulation with Real Data (Server CSV)
                    </span>
                </button>
                <p class="text-[10px] text-gray-500 text-center">
                    Uses pre-configured <code>data/real_skus.csv</code> on the server.
                </p>
            </div>

            <div class="mt-4 pt-4 border-t border-slate-100">
                <h3 class="text-sm font-bold text-gray-800 mb-2 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-indigo-500">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.5 1.5 0 01-1.5-1.5V11.25M3.375 19.5v-7.5c0-.414.336-.75.75-.75h15.75c.414 0 .75.336.75.75v7.5m-17.25 0h17.25"/>
                    </svg>
                    Upload Custom CSV
                </h3>

                <input id="csvFileInput" type="file" accept=".csv" class="hidden"/>

                <label for="csvFileInput"
                       class="inline-flex items-center justify-center w-full text-sm font-semibold px-4 py-2 rounded-lg bg-indigo-sim text-white cursor-pointer hover:bg-indigo-700 transition shadow-md hover:shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-2">
                        <path fill-rule="evenodd" d="M15.75 10.25a.75.75 0 01-.75.75H12V14a.75.75 0 01-1.5 0v-3H7.5a.75.75 0 010-1.5h3v-3a.75.75 0 011.5 0v3h2.25a.75.75 0 01.75.75z" clip-rule="evenodd"/>
                    </svg>
                    Choose CSV File
                </label>

                <p id="csvFileName" class="mt-2 text-xs text-gray-500 text-center">
                    No file selected
                </p>

                <button id="runCsvBtn" disabled
                        class="mt-3 w-full bg-indigo-400 text-white text-sm font-semibold px-4 py-2 rounded-lg opacity-50 cursor-not-allowed">
                    ▶ Run Simulation with Uploaded CSV
                </button>

                <p class="text-[10px] text-gray-500 mt-2 text-center">
                    Required headers: <code>sku_name, annual_demand, order_cost, holding_cost, lead_time_mean, policy</code>.
                </p>
            </div>
        </section>

        <section class="lg:col-span-2 space-y-8">

            <div class="bg-white shadow-xl rounded-2xl p-6 border border-slate-100/80">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-blue-inventory">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v15m0 0v1.5m0-1.5h1.5m1.5 0h13.5m-15 0H7.5m13.5-13.5L16.5 6m3 0l3 3m-3-3l-3 3m-3-3L9 9m3 0l3 3m-3 0L9 12m12-1.5v-7.5m-18 9v7.5"/>
                    </svg>
                    Latest Simulation – Inventory Profiles
                </h2>
                <div class="h-80">
                    <canvas id="inventoryChart"></canvas>
                </div>
                <p class="mt-4 text-xs text-gray-500 text-center">
                    Evolution of **On-Hand Inventory** (Units) over the simulation horizon (Days) for each SKU.
                </p>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                <div class="bg-white shadow-xl rounded-2xl p-6 space-y-6 border border-slate-100/80">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-green-jit">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a6.004 6.004 0 00.75 3.375m3.75 3.75a6.004 6.004 0 003.375.75h7.5a6.004 6.004 0 003.375-.75m-18-6.75a6.004 6.004 0 013.375-3.375h7.5a6.004 6.004 0 013.375 3.375m0 0a6.004 6.004 0 01-3.375 3.375H5.625a6.004 6.004 0 01-3.375-3.375z"/>
                        </svg>
                        Performance Metrics (KPIs)
                    </h3>
                    
                    <div id="portfolioCards" class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
                        <p class="text-sm text-gray-500 col-span-3 text-center py-4">
                            Run a scenario to see the aggregated KPIs for the portfolio.
                        </p>
                    </div>

                    <div class="mt-4">
                        <h4 class="text-sm font-bold text-gray-700 mb-2 flex items-center gap-1">
                            Per-SKU Detailed Metrics
                        </h4>
                        

[Image of an EOQ curve diagram showing minimum total cost]

                        <div class="overflow-x-auto border border-gray-200 rounded-xl">
                            <table class="min-w-full text-xs">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="p-3 text-left border-b border-gray-200 text-gray-600">SKU</th>
                                        <th class="p-3 text-left border-b border-gray-200 text-gray-600">Policy</th>
                                        <th class="p-3 text-right border-b border-gray-200 text-gray-600">EOQ</th>
                                        <th class="p-3 text-right border-b border-gray-200 text-gray-600">ROP</th>
                                        <th class="p-3 text-right border-b border-gray-200 text-gray-600">Safety</th>
                                        <th class="p-3 text-right border-b border-gray-200 text-gray-600">Orders</th>
                                        <th class="p-3 text-right border-b border-gray-200 text-gray-600">Avg Inv</th>
                                        <th class="p-3 text-right border-b border-gray-200 text-gray-600">Fill Rate</th>
                                        <th class="p-3 text-right border-b border-gray-200 text-gray-600">Stockout Days</th>
                                        <th class="p-3 text-right border-b border-gray-200 text-gray-600">Total Cost</th>
                                    </tr>
                                </thead>
                                <tbody id="skuTableBody" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="pt-3 border-t border-slate-100">
                        <button id="toggleRawBtn"
                                class="text-xs text-blue-inventory hover:text-blue-900 underline font-medium">
                            Show / hide raw JSON output
                        </button>
                        <div id="rawJsonBox" class="hidden mt-3">
                            <pre id="kpiRaw" class="text-[10px] bg-gray-900 text-green-200 p-3 rounded-xl max-h-64 overflow-auto shadow-inner">
--</pre>
                        </div>
                    </div>
                </div>

                <div class="bg-white shadow-xl rounded-2xl p-6 space-y-6 border border-slate-100/80">
                    <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-indigo-sim">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5V19.5m-3-3L12 19.5l3-3m-3-10.5L9 4.5m3 0L15 4.5m-3 0v10.5m-3-3h6"/>
                        </svg>
                        Scenario Management
                        <span class="inline-flex items-center rounded-full bg-indigo-50 px-2 py-0.5 text-[10px] font-medium text-indigo-700">
                            History & comparison
                        </span>
                    </h3>

                    <p class="text-sm text-gray-600">
                        Select two scenarios (A and B) to compare their **Total Cost** and **Fill Rate** side by side.
                    </p>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="rounded-xl border border-slate-200 bg-slate-50 p-4 space-y-2">
                            <p class="text-sm font-bold text-slate-700">
                                Scenario A <span class="text-xs font-normal text-slate-500">(Baseline)</span>
                            </p>
                            <select id="scenarioA"
                                    class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-inventory focus:border-blue-inventory transition">
                            </select>
                        </div>

                        <div class="rounded-xl border border-indigo-200 bg-indigo-50 p-4 space-y-2">
                            <p class="text-sm font-bold text-indigo-700">
                                Scenario B <span class="text-xs font-normal text-indigo-500">(Challenger)</span>
                            </p>
                            <select id="scenarioB"
                                    class="w-full border border-indigo-300 rounded-lg px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-indigo-sim focus:border-indigo-sim transition">
                            </select>
                        </div>
                    </div>

                    <div class="mt-4 p-4 border border-indigo-100 rounded-xl bg-indigo-50/50">
                        <h4 class="text-sm font-bold text-indigo-700 mb-2">Comparison Result: A vs B</h4>
                        <div id="comparisonMetrics" class="text-xs text-gray-600">
                            Select scenarios and press 'Compare' to see results.
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-2 pt-2 border-t border-slate-100">
                        <button id="compareBtn"
                                class="col-span-1 flex items-center justify-center gap-1 bg-indigo-sim hover:bg-indigo-700 text-white text-xs font-semibold px-3 py-2 rounded-lg transition shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                <path fill-rule="evenodd" d="M9 3.5A5.5 5.5 0 003.5 9c0 1.05.244 2.05.698 2.924l.322.645A.75.75 0 014.28 13H7.5a.75.75 0 010 1.5H3.25A2.75 2.75 0 01.5 11.25V6.75A2.75 2.75 0 013.25 4h.5a.75.75 0 010 1.5h-.5A1.25 1.25 0 002 6.75v4.5c0 .265.215.475.475.5.021.002.042.003.064.004H7.5a.75.75 0 010 1.5H4.28a2.25 2.25 0 00-.783 2.128l-.322.645A5.501 5.501 0 0014.5 9c0-.498-.073-.99-.214-1.464L15.5 6.5l2.42-2.42A.75.75 0 0119 4.67v10.5a.75.75 0 01-.75.75H.75A.75.75 0 010 15.17V4.67a.75.75 0 011.28-.53l2.42 2.42L4.5 7.536A5.477 5.477 0 009 3.5z" clip-rule="evenodd"/>
                            </svg>
                            Compare A vs B
                        </button>
                        <button id="exportABtn"
                                class="flex items-center justify-center gap-1 bg-slate-700 hover:bg-slate-800 text-white text-xs font-semibold px-3 py-2 rounded-lg transition shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                <path d="M10 2.5a.75.75 0 01.75.75V11a.75.75 0 01-1.5 0V3.25a.75.75 0 01.75-.75z"/>
                                <path fill-rule="evenodd" d="M12.5 12.75a.75.75 0 00-1.5 0v3.5a.75.75 0 001.5 0v-3.5zm-5 0a.75.75 0 00-1.5 0v3.5a.75.75 0 001.5 0v-3.5zm7.5-3.5a.75.75 0 00-1.5 0v3.5a.75.75 0 001.5 0v-3.5z" clip-rule="evenodd"/>
                            </svg>
                            Export A CSV
                        </button>
                        <button id="exportBBtn"
                                class="flex items-center justify-center gap-1 bg-slate-700 hover:bg-slate-800 text-white text-xs font-semibold px-3 py-2 rounded-lg transition shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                <path d="M10 2.5a.75.75 0 01.75.75V11a.75.75 0 01-1.5 0V3.25a.75.75 0 01.75-.75z"/>
                                <path fill-rule="evenodd" d="M12.5 12.75a.75.75 0 00-1.5 0v3.5a.75.75 0 001.5 0v-3.5zm-5 0a.75.75 0 00-1.5 0v3.5a.75.75 0 001.5 0v-3.5zm7.5-3.5a.75.75 0 00-1.5 0v3.5a.75.75 0 001.5 0v-3.5z" clip-rule="evenodd"/>
                            </svg>
                            Export B CSV
                        </button>
                    </div>

                    <div class="pt-4 border-t border-slate-100">
                        <h4 class="text-sm font-bold text-gray-700 mb-2 flex items-center gap-1">
                            Inventory Overlay
                            <span class="text-xs text-gray-400 font-normal">
                                (Scenario A vs B – first SKU)
                            </span>
                        </h4>
                        <div class="h-56 rounded-xl bg-slate-50 border border-slate-200 p-2">
                            <canvas id="compareChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Resto del JavaScript...
        const API_BASE = "http://127.0.0.1:5000";

        // ===========================
        // Utilities
        // ===========================
        function showError(msg) {
            const box = document.getElementById("errorBox");
            if (!msg) {
                box.classList.add("hidden");
                box.textContent = "";
            } else {
                box.textContent = msg;
                box.classList.remove("hidden");
                console.error(msg);
            }
        }

        function formatMoney(x) {
            if (x == null || isNaN(x)) return "--";
            return "$" + Number(x).toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function formatNum(x) {
            if (x == null || isNaN(x)) return "--";
            return Number(x).toLocaleString(undefined, {
                maximumFractionDigits: 0
            });
        }

        function badgePolicy(policy) {
            const p = (policy || "").toUpperCase();
            if (p === "EOQ") {
                return '<span class="px-2 py-0.5 rounded-full bg-blue-100 text-blue-inventory text-[10px] font-semibold">EOQ</span>';
            }
            if (p === "JIT") {
                return '<span class="px-2 py-0.5 rounded-full bg-emerald-100 text-green-jit text-[10px] font-semibold">JIT</span>';
            }
            if (p === "MINMAX") {
                return '<span class="px-2 py-0.5 rounded-full bg-purple-100 text-purple-700 text-[10px] font-semibold">Min-Max</span>';
            }
            return '<span class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 text-[10px] font-semibold">' + policy + "</span>";
        }

        function badgeFillRate(fill) {
            const v = Number(fill);
            if (isNaN(v)) return "--";
            let cls = "bg-red-100 text-red-700";
            if (v >= 98) cls = "bg-emerald-100 text-green-jit";
            else if (v >= 95) cls = "bg-yellow-100 text-yellow-700";
            return '<span class="px-2 py-0.5 rounded-full ' + cls + ' text-[10px] font-semibold">' +
                   v.toFixed(2) + "%</span>";
        }

        // ===========================
        // CSV parsing (for uploaded file)
        // ===========================
        function parseCsvToSkus(csvText, simDays, serviceLevel) {
            const lines = csvText.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
            if (!lines.length) {
                throw new Error("CSV file is empty.");
            }

            const headerLine = lines[0];
            const headers = headerLine.split(",").map(h => h.trim().toLowerCase());

            function idx(colName) {
                const i = headers.indexOf(colName.toLowerCase());
                if (i === -1) {
                    throw new Error("Missing column in CSV header: " + colName);
                }
                return i;
            }

            const iName    = idx("sku_name");
            const iD       = idx("annual_demand");
            const iS       = idx("order_cost");
            const iH       = idx("holding_cost");
            const iLT      = idx("lead_time_mean");
            const iPolicy  = idx("policy");

            const skus = [];

            for (let li = 1; li < lines.length; li++) {
                const line = lines[li];
                if (!line) continue;
                const parts = line.split(",").map(p => p.trim());
                if (parts.length === 1 && parts[0] === "") continue;

                const name     = parts[iName]    || ("SKU-" + li);
                const D        = parseFloat(parts[iD]      || "0");
                const S        = parseFloat(parts[iS]      || "0");
                const H        = parseFloat(parts[iH]      || "0");
                const LT       = parseInt(parts[iLT]      || "1", 10);
                const policy   = (parts[iPolicy] || "EOQ").toUpperCase();

                if (!D || !S || !H || !LT) {
                    console.warn("Skipping row " + li + " due to missing numeric values.");
                    continue;
                }

                skus.push({
                    sku_name: name,
                    annual_demand: D,
                    order_cost: S,
                    holding_cost: H,
                    lead_time_mean: LT,
                    simulation_days: simDays,
                    policy: policy,
                    service_level: serviceLevel
                });
            }

            if (!skus.length) {
                throw new Error("No valid rows found in CSV.");
            }

            return skus;
        }

        function downloadCsv(scenario) {
            if (!scenario || !scenario.output || !scenario.output.SKUs) {
                alert("No scenario data available to export.");
                return;
            }

            const skus = scenario.output.SKUs;
            const scenarioName = scenario.name || "Scenario";

            // Headers for the simulation results
            let csvContent = "SKU,Policy,EOQ,ROP,Safety_Stock,Orders_Count,Average_Inventory,Fill_Rate,Stockout_Days,Total_Cost\n";

            skus.forEach(skuRes => {
                const k = skuRes.KPIs || {};
                const line = [
                    `"${skuRes.sku || ""}"`,
                    `"${k.Policy || ""}"`,
                    k.EOQ,
                    k.ROP,
                    k.Safety_Stock,
                    k.Orders_Count,
                    k.Average_Inventory,
                    k.Fill_Rate,
                    k.Stockout_Days,
                    k.Total_Cost
                ].join(",");
                csvContent += line + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `${scenarioName.replace(/[^a-z0-9]/gi, '_')}_KPIs.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // ===========================
        // Charts
        // ===========================
        let inventoryChart = null;
        let compareChart = null;
        
        const colors = [
            'rgb(29, 78, 216)',    // blue-700
            'rgb(5, 150, 105)',    // emerald-600
            'rgb(79, 70, 229)',    // indigo-600
            'rgb(249, 115, 22)',   // orange-500
            'rgb(168, 85, 247)'    // purple-500
        ];

        function renderSimulationChart(results) {
            const canvas = document.getElementById("inventoryChart");
            if (!canvas) return;
            const ctx = canvas.getContext("2d");

            const skus = results && results.SKUs ? results.SKUs : [];
            if (!skus.length) {
                if (inventoryChart) {
                    inventoryChart.destroy();
                    inventoryChart = null;
                }
                return;
            }

            const histories = skus.map(s => s.Inventory_History || []);
            const maxLen = Math.max.apply(null, histories.map(h => h.length));
            const labels = Array.from({ length: maxLen }, (_, i) => i + 1);

            const datasets = skus.map((s, idx) => {
                const hist = s.Inventory_History || [];
                const data = Array.from({ length: maxLen }, (_, i) =>
                    i < hist.length ? hist[i] : null
                );
                return {
                    label: (s.sku || "SKU " + (idx + 1)) + " (" + (s.KPIs ? s.KPIs.Policy : "") + ")",
                    data,
                    borderColor: colors[idx % colors.length],
                    backgroundColor: colors[idx % colors.length],
                    borderWidth: 2,
                    fill: false,
                    tension: 0.25,
                    pointRadius: 0
                };
            });

            if (inventoryChart) {
                inventoryChart.destroy();
            }

            inventoryChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels,
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: "Day" }
                        },
                        y: {
                            title: { display: true, text: "On-hand inventory (units)" },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: { position: "bottom" }
                    }
                }
            });
        }

        function renderOverlayChart(scenarioA, scenarioB) {
            const canvas = document.getElementById("compareChart");
            if (!canvas) return;
            const ctx = canvas.getContext("2d");

            if (compareChart) {
                compareChart.destroy();
                compareChart = null;
            }

            if (!scenarioA || !scenarioB) return;

            const outA = scenarioA.output || {};
            const outB = scenarioB.output || {};

            const skuA = (outA.SKUs && outA.SKUs[0]) ? outA.SKUs[0] : null;
            const skuB = (outB.SKUs && outB.SKUs[0]) ? outB.SKUs[0] : null;

            const histA = skuA && skuA.Inventory_History ? skuA.Inventory_History : [];
            const histB = skuB && skuB.Inventory_History ? skuB.Inventory_History : [];

            const maxLen = Math.max(histA.length, histB.length);
            if (!maxLen) return;

            const labels = Array.from({ length: maxLen }, (_, i) => i + 1);

            compareChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels,
                    datasets: [
                        {
                            label: "A: " + (scenarioA.name || "Scenario A") + (skuA ? " (" + skuA.sku + " - " + (skuA.KPIs ? skuA.KPIs.Policy : "") + ")" : ""),
                            data: Array.from({ length: maxLen }, (_, i) => i < histA.length ? histA[i] : null),
                            borderColor: 'rgb(29, 78, 216)',
                            backgroundColor: 'rgb(29, 78, 216)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.25,
                            pointRadius: 0
                        },
                        {
                            label: "B: " + (scenarioB.name || "Scenario B") + (skuB ? " (" + skuB.sku + " - " + (skuB.KPIs ? skuB.KPIs.Policy : "") + ")" : ""),
                            data: Array.from({ length: maxLen }, (_, i) => i < histB.length ? histB[i] : null),
                            borderColor: 'rgb(79, 70, 229)',
                            backgroundColor: 'rgb(79, 70, 229)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.25,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: "bottom" }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: "Day" }
                        },
                        y: {
                            title: { display: true, text: "On-hand inventory (units)" },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // ===========================
        // KPIs rendering
        // ===========================
        function renderKPIs(results) {
            if (!results) return;

            const raw = document.getElementById("kpiRaw");
            if (raw) {
                raw.textContent = JSON.stringify(results, null, 2);
            }

            const cards = document.getElementById("portfolioCards");
            if (cards) {
                const totalCost = results.Total_Cost;
                const avgFill = results.Average_Fill_Rate;
                const numSkus = results.SKUs ? results.SKUs.length : 0;
                const totalOrders = results.SKUs ? results.SKUs.reduce((sum, s) => sum + (s.KPIs.Orders_Count || 0), 0) : 0;


                cards.innerHTML = `
                    <div class="p-3 rounded-lg border border-gray-200 bg-white shadow-sm">
                        <p class="text-[11px] text-gray-500">Total Cost (Portfolio)</p>
                        <p class="text-xl font-bold text-gray-900">${formatMoney(totalCost)}</p>
                        <p class="text-[11px] text-gray-500 mt-1">Holding + Ordering Cost</p>
                    </div>
                    <div class="p-3 rounded-lg border border-gray-200 bg-white shadow-sm">
                        <p class="text-[11px] text-gray-500">Average Fill Rate</p>
                        <p class="text-xl font-bold text-gray-900">${avgFill != null ? avgFill.toFixed(2) + "%" : "--"}</p>
                        <p class="text-[11px] text-gray-500 mt-1">Demand-weighted</p>
                    </div>
                    <div class="p-3 rounded-lg border border-gray-200 bg-white shadow-sm">
                        <p class="text-[11px] text-gray-500">Total Orders</p>
                        <p class="text-xl font-bold text-gray-900">${formatNum(totalOrders)}</p>
                        <p class="text-[11px] text-gray-500 mt-1">Across all SKUs</p>
                    </div>
                `;
            }

            const body = document.getElementById("skuTableBody");
            if (body) {
                body.innerHTML = "";
                const skus = results.SKUs || [];
                skus.forEach((skuRes) => {
                    const k = skuRes.KPIs || {};
                    const tr = document.createElement("tr");
                    tr.classList.add('hover:bg-slate-50');
                    tr.innerHTML = `
                        <td class="p-3 border-b border-gray-100 font-semibold text-gray-800">${skuRes.sku || "--"}</td>
                        <td class="p-3 border-b border-gray-100">${badgePolicy(k.Policy)}</td>
                        <td class="p-3 border-b border-gray-100 text-right text-gray-700">${formatNum(k.EOQ)}</td>
                        <td class="p-3 border-b border-gray-100 text-right text-gray-700">${formatNum(k.ROP)}</td>
                        <td class="p-3 border-b border-gray-100 text-right text-gray-700">${formatNum(k.Safety_Stock)}</td>
                        <td class="p-3 border-b border-gray-100 text-right text-gray-700">${formatNum(k.Orders_Count)}</td>
                        <td class="p-3 border-b border-gray-100 text-right text-gray-700">${formatNum(k.Average_Inventory)}</td>
                        <td class="p-3 border-b border-gray-100 text-right">${badgeFillRate(k.Fill_Rate)}</td>
                        <td class="p-3 border-b border-gray-100 text-right text-gray-700">${formatNum(k.Stockout_Days)}</td>
                        <td class="p-3 border-b border-gray-100 text-right font-bold text-gray-900">${formatMoney(k.Total_Cost)}</td>
                    `;
                    body.appendChild(tr);
                });
            }

            renderSimulationChart(results);
        }

        function renderComparison(scenarioA, scenarioB) {
            const compDiv = document.getElementById("comparisonMetrics");
            if (!compDiv) return;

            if (!scenarioA || !scenarioB || !scenarioA.output || !scenarioB.output) {
                compDiv.innerHTML = '<p class="text-xs text-gray-600">Select scenarios and press \'Compare\' to see results.</p>';
                renderOverlayChart(null, null);
                return;
            }

            const resA = scenarioA.output;
            const resB = scenarioB.output;
            const costA = resA.Total_Cost || 0;
            const costB = resB.Total_Cost || 0;
            const fillA = resA.Average_Fill_Rate || 0;
            const fillB = resB.Average_Fill_Rate || 0;

            const costDiff = costB - costA;
            const fillDiff = fillB - fillA;

            const costClass = costDiff < 0 ? 'text-green-600' : 'text-red-600';
            const costArrow = costDiff < 0 ? '↓' : costDiff > 0 ? '↑' : '-';
            const fillClass = fillDiff > 0 ? 'text-green-600' : 'text-red-600';
            const fillArrow = fillDiff > 0 ? '↑' : fillDiff < 0 ? '↓' : '-';

            compDiv.innerHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between items-center text-sm">
                        <span class="font-semibold">Total Cost Difference (B vs A):</span>
                        <span class="font-bold ${costClass}">${costArrow} ${formatMoney(Math.abs(costDiff))}</span>
                    </div>
                    <div class="flex justify-between items-center text-sm">
                        <span class="font-semibold">Avg Fill Rate Difference (B vs A):</span>
                        <span class="font-bold ${fillClass}">${fillArrow} ${Math.abs(fillDiff).toFixed(2)}%</span>
                    </div>
                    <div class="flex justify-between items-center text-xs pt-2 border-t border-indigo-200">
                        <span>A Cost: ${formatMoney(costA)}</span>
                        <span>B Cost: ${formatMoney(costB)}</span>
                    </div>
                    <div class="flex justify-between items-center text-xs">
                        <span>A Fill Rate: ${fillA.toFixed(2)}%</span>
                        <span>B Fill Rate: ${fillB.toFixed(2)}%</span>
                    </div>
                </div>
            `;

            renderOverlayChart(scenarioA, scenarioB);
        }
        
        // --- Global Store for Scenarios ---
        let scenariosStore = {};

        // ===========================
        // API helpers (using API_BASE)
        // ===========================
        async function fetchScenarios() {
            const ddA = document.getElementById("scenarioA");
            const ddB = document.getElementById("scenarioB");
            if (!ddA || !ddB) return;

            ddA.innerHTML = "";
            ddB.innerHTML = "";
            scenariosStore = {};

            try {
                const res = await fetch(API_BASE + "/api/scenarios");
                const text = await res.text();

                let data;
                try {
                    data = text ? JSON.parse(text) : [];
                } catch (e) {
                    console.error("Non-JSON response from /api/scenarios:", text);
                    showError(
                        "Backend returned HTML instead of JSON for /api/scenarios. " +
                        "Make sure the Flask server is running (python app.py) at " + API_BASE + "."
                    );
                    return;
                }

                const scenarios = Array.isArray(data) ? data : [];
                scenarios.sort((a, b) => (b.id || 0) - (a.id || 0));

                scenarios.forEach((s) => {
                    scenariosStore[s.id] = s;
                    const date = s.created_at ? new Date(s.created_at) : null;
                    const label =
                        `ID ${s.id}: ` + (s.name || "Scenario " + s.id) +
                        (date ? " — " + date.toLocaleString() : "");

                    const optA = document.createElement("option");
                    optA.value = s.id;
                    optA.textContent = label;
                    ddA.appendChild(optA);

                    const optB = document.createElement("option");
                    optB.value = s.id;
                    optB.textContent = label;
                    ddB.appendChild(optB);
                });
                
                // Trigger initial KPI render on load of latest scenario
                if (scenarios.length > 0 && scenarios[0].output) {
                    renderKPIs(scenarios[0].output);
                }

                // Auto-select latest two for comparison
                if (scenarios.length > 0) ddA.value = scenarios[0].id;
                if (scenarios.length > 1) ddB.value = scenarios[1].id;
                else if (scenarios.length > 0) ddB.value = scenarios[0].id; // Fallback: select same if only one exists


            } catch (err) {
                showError("Network error loading scenarios: " + err);
            }
        }

        async function loadScenario(id) {
            if (scenariosStore[id] && scenariosStore[id].output) {
                return scenariosStore[id];
            }

            const res = await fetch(API_BASE + "/api/scenarios/" + encodeURIComponent(id));
            const data = await res.json();
            if (!res.ok) {
                throw new Error(data && data.error ? data.error : ("Failed to load scenario " + id));
            }
            scenariosStore[id] = data; // Cache the full scenario data
            return data;
        }

        async function simulateWithSkus(scenarioName, simDays, serviceLevel, skus) {
            const payload = {
                scenarioName: scenarioName,
                simulationDays: simDays,
                serviceLevel: serviceLevel,
                skus: skus
            };

            document.getElementById("runBtn").disabled = true;
            document.getElementById("runBtn").textContent = "Simulating...";

            try {
                const res = await fetch(API_BASE + "/api/simulate", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (!res.ok) {
                    showError(data && data.error ? data.error : ("Simulation error: " + res.status));
                    return;
                }

                showError("");
                if (data && data.results) {
                    renderKPIs(data.results);
                }

                await fetchScenarios();
            } catch (err) {
                showError("Network error calling /api/simulate: " + err);
            } finally {
                document.getElementById("runBtn").disabled = false;
                document.getElementById("runBtn").innerHTML = `<span class="inline-flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M2.5 5.5A.75.75 0 013.25 4h13.5a.75.75 0 01.75.75v10.5a.75.75 0 01-.75.75H3.25a.75.75 0 01-.75-.75v-10.5zM17 5.5v9h-13v-9h13z" clip-rule="evenodd"/></svg>▶ Run & Save Scenario (Manual SKUs)</span>`;
            }
        }

        async function simulateRealData() {
             // Logic for simulate_real button (simular a runScenarioManual pero a otra API)
             showError("");

            const simDays = parseInt(document.getElementById("simDays").value, 10);
            const serviceLevelPct = parseFloat(document.getElementById("serviceLevel").value);

            if (!simDays || simDays <= 0) {
                showError("Please enter a valid number of simulation days.");
                return;
            }
            if (!serviceLevelPct || serviceLevelPct <= 0) {
                showError("Please enter a valid service level (%).");
                return;
            }

            const serviceLevel = serviceLevelPct > 1 ? serviceLevelPct / 100 : serviceLevelPct;

            const payload = {
                simulationDays: simDays,
                serviceLevel: serviceLevel,
                scenarioName: "Real Data Run " + new Date().toLocaleString()
            };

            document.getElementById("runRealBtn").disabled = true;
            document.getElementById("runRealBtn").textContent = "Simulating...";

            try {
                const res = await fetch(API_BASE + "/api/simulate_real", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (!res.ok) {
                    showError(data && data.error ? data.error : ("Simulation error: " + res.status));
                    return;
                }

                showError("");
                if (data && data.results) {
                    renderKPIs(data.results);
                }
                
                await fetchScenarios();
            } catch (err) {
                showError("Network error calling /api/simulate_real: " + err);
            } finally {
                document.getElementById("runRealBtn").disabled = false;
                document.getElementById("runRealBtn").innerHTML = `<span class="inline-flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M6 3.5a.5.5 0 01.5-.5h7a.5.5 0 01.5.5v3.5h-8V3.5zM7.5 7h5V4.5h-5V7zM3 10a2 2 2 012-2h10a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5zm2 0h10v5H5v-5z" clip-rule="evenodd"/></svg>▶ Run Simulation with Real Data (Server CSV)</span>`;
            }
        }


        // ===========================
        // Scenario runners
        // ===========================
        async function runScenarioManual() {
            showError("");

            const scenarioName = document.getElementById("scenarioName").value || "Manual Scenario";
            const simDays = parseInt(document.getElementById("simDays").value, 10);
            const serviceLevelPct = parseFloat(document.getElementById("serviceLevel").value);

            if (!simDays || simDays <= 0) {
                showError("Please enter a valid number of simulation days.");
                return;
            }
            if (!serviceLevelPct || serviceLevelPct <= 0) {
                showError("Please enter a valid service level (%).");
                return;
            }

            const serviceLevel = serviceLevelPct > 1 ? serviceLevelPct / 100 : serviceLevelPct;

            function readSku(idx) {
                const name = document.getElementById("sku" + idx + "_name").value || ("SKU-" + idx);
                const D = parseFloat(document.getElementById("sku" + idx + "_D").value);
                const S = parseFloat(document.getElementById("sku" + idx + "_S").value);
                const H = parseFloat(document.getElementById("sku" + idx + "_H").value);
                const LT = parseInt(document.getElementById("sku" + idx + "_LT").value, 10);
                const policy = document.getElementById("sku" + idx + "_policy").value || "EOQ";

                if (isNaN(D) || isNaN(S) || isNaN(H) || isNaN(LT)) {
                    throw new Error("Please fill all numeric fields for SKU " + idx + ".");
                }

                return {
                    sku_name: name,
                    annual_demand: D,
                    order_cost: S,
                    holding_cost: H,
                    lead_time_mean: LT,
                    simulation_days: simDays,
                    policy: policy,
                    service_level: serviceLevel
                };
            }

            let skus;
            try {
                skus = [readSku(1), readSku(2)];
            } catch (err) {
                showError(err.message);
                return;
            }

            await simulateWithSkus(scenarioName, simDays, serviceLevel, skus);
        }

        async function runScenarioFromCsvFile() {
            showError("");

            const fileInput = document.getElementById("csvFileInput");
            if (!fileInput || !fileInput.files || !fileInput.files.length) {
                showError("Please choose a CSV file first.");
                return;
            }

            const file = fileInput.files[0];

            const simDays = parseInt(document.getElementById("simDays").value, 10);
            const serviceLevelPct = parseFloat(document.getElementById("serviceLevel").value);

            if (!simDays || simDays <= 0) {
                showError("Please enter a valid number of simulation days.");
                return;
            }
            if (!serviceLevelPct || serviceLevelPct <= 0) {
                showError("Please enter a valid service level (%).");
                return;
            }

            const serviceLevel = serviceLevelPct > 1 ? serviceLevelPct / 100 : serviceLevelPct;
            const scenarioName = document.getElementById("scenarioName").value || "Uploaded CSV Scenario: " + file.name;

            const runBtn = document.getElementById("runCsvBtn");
            runBtn.disabled = true;
            runBtn.textContent = "Loading file...";

            const reader = new FileReader();

            reader.onload = async (e) => {
                const csvText = e.target.result;
                let skus;
                try {
                    skus = parseCsvToSkus(csvText, simDays, serviceLevel);
                    runBtn.textContent = "Simulating...";
                    await simulateWithSkus(scenarioName, simDays, serviceLevel, skus);
                } catch (err) {
                    showError("CSV Parse Error: " + err.message);
                } finally {
                    runBtn.disabled = false;
                    runBtn.textContent = "▶ Run Simulation with Uploaded CSV";
                }
            };

            reader.onerror = () => {
                showError("Error reading CSV file.");
                runBtn.disabled = false;
                runBtn.textContent = "▶ Run Simulation with Uploaded CSV";
            };

            reader.readAsText(file);
        }

        async function compareScenarios() {
            const idA = document.getElementById("scenarioA").value;
            const idB = document.getElementById("scenarioB").value;

            if (!idA || !idB) {
                showError("Please select both Scenario A and Scenario B to compare.");
                return;
            }

            try {
                // Fetch A and B in parallel if not already cached
                const [scenarioA, scenarioB] = await Promise.all([
                    loadScenario(idA),
                    loadScenario(idB)
                ]);

                if (scenarioA.output && scenarioB.output) {
                    renderComparison(scenarioA, scenarioB);
                    renderKPIs(scenarioA.output); // Show Scenario A KPIs as the default view
                } else {
                    showError("One or both selected scenarios are missing simulation output data.");
                }
            } catch (err) {
                showError("Error during scenario comparison: " + err);
            }
        }
        
        async function exportScenarioACsv() {
            const idA = document.getElementById("scenarioA").value;
            if (!idA) {
                alert("Please select Scenario A to export.");
                return;
            }
            try {
                const scenarioA = await loadScenario(idA);
                downloadCsv(scenarioA);
            } catch (err) {
                showError("Error exporting Scenario A: " + err);
            }
        }

        async function exportScenarioBCsv() {
            const idB = document.getElementById("scenarioB").value;
            if (!idB) {
                alert("Please select Scenario B to export.");
                return;
            }
            try {
                const scenarioB = await loadScenario(idB);
                downloadCsv(scenarioB);
            } catch (err) {
                showError("Error exporting Scenario B: " + err);
            }
        }

        // ===========================
        // Event Listeners
        // ===========================
        document.addEventListener("DOMContentLoaded", () => {
            fetchScenarios();

            document.getElementById("runBtn").addEventListener("click", runScenarioManual);
            document.getElementById("runRealBtn").addEventListener("click", simulateRealData);
            document.getElementById("runCsvBtn").addEventListener("click", runScenarioFromCsvFile);
            document.getElementById("compareBtn").addEventListener("click", compareScenarios);
            document.getElementById("exportABtn").addEventListener("click", exportScenarioACsv);
            document.getElementById("exportBBtn").addEventListener("click", exportScenarioBCsv);
            
            // Toggle raw JSON
            document.getElementById("toggleRawBtn").addEventListener("click", () => {
                document.getElementById("rawJsonBox").classList.toggle("hidden");
            });
            
            // File input logic
            document.getElementById("csvFileInput").addEventListener("change", (e) => {
                const fileNameDisplay = document.getElementById("csvFileName");
                const runCsvBtn = document.getElementById("runCsvBtn");
                if (e.target.files && e.target.files.length > 0) {
                    fileNameDisplay.textContent = e.target.files[0].name;
                    runCsvBtn.disabled = false;
                    runCsvBtn.classList.remove("bg-indigo-400", "opacity-50", "cursor-not-allowed");
                    runCsvBtn.classList.add("bg-indigo-sim", "hover:bg-indigo-700");
                } else {
                    fileNameDisplay.textContent = "No file selected";
                    runCsvBtn.disabled = true;
                    runCsvBtn.classList.remove("bg-indigo-sim", "hover:bg-indigo-700");
                    runCsvBtn.classList.add("bg-indigo-400", "opacity-50", "cursor-not-allowed");
                }
            });
        });
    </script>
</body>
</html>
